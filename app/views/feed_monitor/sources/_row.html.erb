<% rate_map = local_assigns[:item_activity_rates] || {} %>
<% activity_rate = rate_map.fetch(source.id, nil) %>
<% activity_rate = FeedMonitor::Analytics::SourceActivityRates.rate_for(source) if activity_rate.nil? %>
<% health_status = if !source.active?
    { label: "Paused", classes: "bg-amber-100 text-amber-700" }
  else
    source_health_badge(source)
  end %>
<% fetch_status = async_status_badge(source.fetch_status) %>

<tr id="<%= dom_id(source, :row) %>" class="hover:bg-slate-50">
  <td class="px-6 py-4">
    <div class="font-medium text-slate-900"><%= source.name %></div>
    <div class="text-xs text-slate-500 truncate max-w-xs"><%= source.feed_url %></div>
  </td>
  <td class="px-6 py-4">
    <div class="flex flex-col gap-2 text-xs">
      <span class="inline-flex items-center rounded-full px-3 py-1 font-semibold <%= health_status[:classes] %>"><%= health_status[:label] %></span>
      <% if source.rolling_success_rate.present? %>
        <span class="text-[11px] text-slate-500">Success Rate: <%= number_to_percentage(source.rolling_success_rate * 100, precision: 0) %></span>
      <% end %>
      <span class="inline-flex items-center rounded-full px-3 py-1 font-semibold <%= fetch_status[:classes] %>">
        <%= loading_spinner_svg(css_class: "mr-1 h-3.5 w-3.5 animate-spin text-blue-500") if fetch_status[:show_spinner] %>
        <%= fetch_status[:label] %>
        <% if source.fetch_status == "fetching" && source.last_fetch_started_at.present? %>
          <span class="ml-2 font-normal text-[10px] text-slate-500">(since <%= source.last_fetch_started_at.strftime("%H:%M:%S") %>)</span>
        <% end %>
      </span>
    </div>
  </td>
  <td class="px-6 py-4 text-sm">
    <%= "#{source.fetch_interval_minutes} min" %>
    <span class="text-xs text-slate-500">(~<%= number_with_precision(source.fetch_interval_minutes / 60.0, precision: 2) %> h)</span>
  </td>
  <td class="px-6 py-4 text-sm"><%= source.items_count %></td>
  <td class="px-6 py-4 text-sm">
    <%= number_with_precision(activity_rate, precision: 2) %>
    <span class="text-xs text-slate-500">/ day</span>
  </td>
  <td class="px-6 py-4 text-xs text-slate-500">
    <%= source.last_fetched_at ? source.last_fetched_at.strftime("%b %d, %H:%M") : "Never" %>
  </td>
  <td class="px-6 py-4 text-right text-sm">
    <%= link_to "View", feed_monitor.source_path(source), class: "text-blue-600 hover:text-blue-500" %>
    <span class="mx-2 text-slate-300">|</span>
    <%= link_to "Edit", feed_monitor.edit_source_path(source), class: "text-slate-600 hover:text-slate-500" %>
  </td>
</tr>
