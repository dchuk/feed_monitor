<% rate_map = local_assigns[:item_activity_rates] || {} %>
<% activity_rate = rate_map.fetch(source.id, nil) %>
<% activity_rate = FeedMonitor::Analytics::SourceActivityRates.rate_for(source) if activity_rate.nil? %>
<% health_status = if !source.active?
    { label: "Paused", classes: "bg-amber-100 text-amber-700" }
  else
    source_health_badge(source)
  end %>
<% fetch_status = async_status_badge(source.fetch_status) %>
<% search_params = local_assigns[:search_params] || {} %>
<% delete_query =
     if search_params.respond_to?(:to_unsafe_h)
       search_params.to_unsafe_h
     elsif search_params.respond_to?(:to_h)
       search_params.to_h
     elsif search_params.is_a?(Hash)
       search_params
     else
       {}
     end %>
<% delete_query = delete_query.respond_to?(:compact_blank) ? delete_query.compact_blank : delete_query.reject { |_key, value| value.respond_to?(:blank?) ? value.blank? : value.nil? } if delete_query.present? %>
<% delete_path = delete_query.present? ? feed_monitor.source_path(source, q: delete_query) : feed_monitor.source_path(source) %>

<tr id="<%= dom_id(source, :row) %>" class="hover:bg-slate-50">
  <td class="px-6 py-4">
    <div class="font-medium text-slate-900">
      <%= link_to source.name,
            feed_monitor.source_path(source),
            class: "text-slate-900 hover:text-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2",
            data: { turbo_frame: "_top" } %>
    </div>
    <div class="text-xs text-slate-500 truncate max-w-xs"><%= source.feed_url %></div>
  </td>
  <td class="px-6 py-4">
    <div class="flex flex-col gap-2 text-xs">
      <span class="inline-flex items-center rounded-full px-3 py-1 font-semibold <%= health_status[:classes] %>"><%= health_status[:label] %></span>
      <% if source.rolling_success_rate.present? %>
        <span class="text-[11px] text-slate-500">Success Rate: <%= number_to_percentage(source.rolling_success_rate * 100, precision: 0) %></span>
      <% end %>
      <span class="inline-flex items-center rounded-full px-3 py-1 font-semibold <%= fetch_status[:classes] %>">
        <%= loading_spinner_svg(css_class: "mr-1 h-3.5 w-3.5 animate-spin text-blue-500") if fetch_status[:show_spinner] %>
        <%= fetch_status[:label] %>
        <% if source.fetch_status == "fetching" && source.last_fetch_started_at.present? %>
          <span class="ml-2 font-normal text-[10px] text-slate-500">(since <%= source.last_fetch_started_at.strftime("%H:%M:%S") %>)</span>
        <% end %>
      </span>
    </div>
  </td>
  <td class="px-6 py-4 text-sm">
    <%= "#{source.fetch_interval_minutes} min" %>
    <span class="text-xs text-slate-500">(~<%= number_with_precision(source.fetch_interval_minutes / 60.0, precision: 2) %> h)</span>
  </td>
  <td class="px-6 py-4 text-sm"><%= source.items_count %></td>
  <td class="px-6 py-4 text-sm">
    <%= number_with_precision(activity_rate, precision: 2) %>
    <span class="text-xs text-slate-500">/ day</span>
  </td>
  <td class="px-6 py-4 text-xs text-slate-500">
    <%= source.last_fetched_at ? source.last_fetched_at.strftime("%b %d, %H:%M") : "Never" %>
  </td>
  <td class="px-6 py-4 text-right text-sm">
    <div data-controller="dropdown" class="relative inline-block text-left">
      <button type="button"
              class="inline-flex items-center rounded-md border border-slate-200 bg-white px-2.5 py-1.5 text-slate-600 shadow-sm hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              data-action="dropdown#toggle click@window->dropdown#hide"
              aria-label="Source actions">
        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94a.75.75 0 0 0-1.093-.332l-.822.548a2.25 2.25 0 0 1-2.287.014l-.856-.506a.75.75 0 0 0-1.087.63l.03.988a2.25 2.25 0 0 1-.639 1.668l-.715.715a.75.75 0 0 0 0 1.06l.715.715a2.25 2.25 0 0 1 .639 1.668l-.03.988a.75.75 0 0 0 1.087.63l.856-.506a2.25 2.25 0 0 1 2.287.014l.822.548a.75.75 0 0 0 1.093-.332l.38-.926a2.25 2.25 0 0 1 1.451-1.297l.964-.258a.75.75 0 0 0 .534-.72v-.946a.75.75 0 0 0-.534-.72l-.964-.258a2.25 2.25 0 0 1-1.45-1.297l-.381-.926Z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 10a2 2 0 1 1-4 0 2 2 0 0 1 4 0Z" />
        </svg>
      </button>
      <div data-dropdown-target="menu" class="absolute right-0 z-10 mt-2 w-36 origin-top-right rounded-md border border-slate-200 bg-white shadow-lg transition hidden">
        <div class="py-1 text-sm text-slate-700">
          <%= link_to "View",
                feed_monitor.source_path(source),
                class: "block px-3 py-2 hover:bg-slate-50",
                data: { action: "dropdown#toggle", turbo_frame: "_top" } %>
          <%= link_to "Edit",
                feed_monitor.edit_source_path(source),
                class: "block px-3 py-2 hover:bg-slate-50",
                data: { action: "dropdown#toggle", turbo_frame: "_top" } %>
          <div class="my-1 border-t border-slate-100"></div>
          <%= link_to "Delete",
                delete_path,
                class: "block px-3 py-2 text-rose-600 hover:bg-rose-50 hover:text-rose-700",
                title: "Delete source and remove associated items/logs",
                data: {
                  action: "dropdown#toggle",
                  turbo_method: :delete,
                  turbo_confirm: "Delete this source and remove all associated data?"
                } %>
        </div>
      </div>
    </div>
  </td>
</tr>
