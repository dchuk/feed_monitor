<div class="space-y-6">
  <%= turbo_stream_from "feed_monitor_sources" %>
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <h1 class="text-3xl font-semibold text-slate-900">Sources</h1>
      <p class="mt-1 text-sm text-slate-500">Manage feed endpoints and scraping settings.</p>
    </div>
    <div class="flex w-full flex-col gap-3 sm:w-auto sm:flex-row sm:items-center">
      <%= search_form_for @q, url: feed_monitor.sources_path, method: :get, html: { class: "w-full sm:w-auto" } do |form| %>
        <%= form.label @search_field, "Search sources", class: "sr-only" %>
        <div class="flex rounded-md shadow-sm">
          <%= form.search_field @search_field, placeholder: "Search name or URL…", class: "w-full rounded-l-md border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 sm:min-w-[16rem]" %>
          <%= form.submit "Search", class: "rounded-r-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-500" %>
        </div>
      <% end %>
      <%= link_to "New Source", feed_monitor.new_source_path, class: "inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-500" %>
    </div>
  </div>

  <% if @search_term.present? || @fetch_interval_filter.present? %>
    <div class="rounded-md border border-blue-100 bg-blue-50 px-4 py-3 text-xs text-blue-700">
      <% if @search_term.present? %>
        <% clear_search_query = @search_params.dup %>
        <% clear_search_query.delete("name_or_feed_url_or_website_url_cont") %>
        <% clear_search_query = if clear_search_query.respond_to?(:compact_blank)
          clear_search_query.compact_blank
        else
          clear_search_query.reject { |_key, value| value.respond_to?(:blank?) ? value.blank? : value.nil? }
        end %>
        <% clear_search_path = clear_search_query.empty? ? feed_monitor.sources_path : feed_monitor.sources_path(q: clear_search_query) %>
        <div>
          Showing results for “<%= @search_term %>”.
          <%= link_to "Clear search", clear_search_path, class: "ml-2 font-medium text-blue-600 hover:text-blue-500" %>
        </div>
      <% end %>

      <% if @fetch_interval_filter.present? %>
        <% filter_label = fetch_interval_filter_label(@selected_fetch_interval_bucket, @fetch_interval_filter) %>
        <div class="mt-1 flex items-center justify-between gap-2">
          <span>Filtered by fetch interval <%= filter_label %>.</span>
          <%= link_to "Clear interval filter",
                fetch_interval_bucket_path(@selected_fetch_interval_bucket, @search_params, selected: true),
                class: "font-medium text-blue-600 hover:text-blue-500" %>
        </div>
      <% end %>
    </div>
  <% end %>

  <div class="overflow-hidden rounded-lg border border-slate-200 bg-white shadow-sm">
    <div class="border-b border-slate-200 bg-slate-50 px-6 py-4">
      <h2 class="text-base font-semibold text-slate-900">Fetch Interval Distribution</h2>
      <p class="mt-1 text-xs text-slate-500">Heatmap shows how many sources sit in each scheduling bucket.</p>
    </div>
    <div class="px-6 py-4" data-testid="fetch-interval-heatmap">
      <% max_count = @fetch_interval_distribution.map(&:count).max.to_i %>
      <table class="w-full table-fixed text-center text-sm">
        <thead class="text-xs font-semibold uppercase tracking-wide text-slate-500">
          <tr>
            <% @fetch_interval_distribution.each do |bucket| %>
              <th scope="col" class="px-2 pb-3"><%= bucket.label %></th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <tr>
            <% @fetch_interval_distribution.each do |bucket| %>
              <% bucket_classes = heatmap_bucket_classes(bucket.count, max_count) %>
              <% selected = bucket == @selected_fetch_interval_bucket %>
              <% link_path = fetch_interval_bucket_path(bucket, @search_params, selected: selected) %>
              <% bucket_key = [bucket.min || 0, bucket.max || "plus"].join("-") %>
              <% highlight_classes = selected ? "ring-2 ring-blue-500 shadow-lg" : "ring-1 ring-transparent hover:ring-blue-400 hover:shadow" %>
              <td class="px-2">
                <%= link_to link_path,
                      class: "block focus:outline-none group",
                      data: { turbo_frame: "_top" },
                      "data-testid" => "fetch-interval-bucket-#{bucket_key}",
                      aria: { label: selected ? "Show all sources" : "Filter sources by #{bucket.label}" } do %>
                  <div class="flex flex-col items-center justify-center gap-1 rounded-lg px-3 py-4 text-xs font-semibold transition <%= bucket_classes %> <%= highlight_classes %>"
                       title="<%= "#{bucket.count} sources between #{bucket.label}" %>">
                    <span class="text-base"><%= bucket.count %></span>
                    <span class="font-medium">sources</span>
                  </div>
                <% end %>
              </td>
            <% end %>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="overflow-hidden rounded-lg border border-slate-200 bg-white shadow-sm">
    <%= turbo_frame_tag "feed_monitor_sources_table" do %>
      <table class="min-w-full divide-y divide-slate-200 text-left text-sm">
        <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-500">
          <tr>
            <th scope="col"
                class="px-6 py-3"
                data-sort-column="name"
                aria-sort="<%= table_sort_aria(@q, :name) %>">
              <span class="inline-flex items-center gap-1">
                <%= table_sort_link(
                      @q,
                      :name,
                      "Source",
                      frame: "feed_monitor_sources_table",
                      default_order: :asc,
                      secondary: ["created_at desc"],
                      html_options: {
                        class: "inline-flex items-center gap-1 text-xs font-semibold uppercase tracking-wide text-slate-600 hover:text-slate-900 focus:outline-none"
                      }
                    ) %>
                <span class="text-[11px] text-slate-400" aria-hidden="true"><%= table_sort_arrow(@q, :name) %></span>
              </span>
            </th>
            <th scope="col" class="px-6 py-3">Status</th>
            <th scope="col"
                class="px-6 py-3"
                data-sort-column="fetch_interval_minutes"
                aria-sort="<%= table_sort_aria(@q, :fetch_interval_minutes) %>">
              <span class="inline-flex items-center gap-1">
                <%= table_sort_link(
                      @q,
                      :fetch_interval_minutes,
                      "Fetch Interval",
                      frame: "feed_monitor_sources_table",
                      default_order: :asc,
                      secondary: ["created_at desc"],
                      html_options: {
                        class: "inline-flex items-center gap-1 text-xs font-semibold uppercase tracking-wide text-slate-600 hover:text-slate-900 focus:outline-none"
                      }
                    ) %>
                <span class="text-[11px] text-slate-400" aria-hidden="true"><%= table_sort_arrow(@q, :fetch_interval_minutes) %></span>
              </span>
            </th>
            <th scope="col"
                class="px-6 py-3"
                data-sort-column="items_count"
                aria-sort="<%= table_sort_aria(@q, :items_count) %>">
              <span class="inline-flex items-center gap-1">
                <%= table_sort_link(
                      @q,
                      :items_count,
                      "Items",
                      frame: "feed_monitor_sources_table",
                      default_order: :desc,
                      secondary: ["created_at desc"],
                      html_options: {
                        class: "inline-flex items-center gap-1 text-xs font-semibold uppercase tracking-wide text-slate-600 hover:text-slate-900 focus:outline-none"
                      }
                    ) %>
                <span class="text-[11px] text-slate-400" aria-hidden="true"><%= table_sort_arrow(@q, :items_count) %></span>
              </span>
            </th>
            <th scope="col" class="px-6 py-3">New Items / Day</th>
            <th scope="col"
                class="px-6 py-3"
                data-sort-column="last_fetched_at"
                aria-sort="<%= table_sort_aria(@q, :last_fetched_at) %>">
              <span class="inline-flex items-center gap-1">
                <%= table_sort_link(
                      @q,
                      :last_fetched_at,
                      "Last Fetch",
                      frame: "feed_monitor_sources_table",
                      default_order: :desc,
                      secondary: ["created_at desc"],
                      html_options: {
                        class: "inline-flex items-center gap-1 text-xs font-semibold uppercase tracking-wide text-slate-600 hover:text-slate-900 focus:outline-none"
                      }
                    ) %>
                <span class="text-[11px] text-slate-400" aria-hidden="true"><%= table_sort_arrow(@q, :last_fetched_at) %></span>
              </span>
            </th>
            <th scope="col" class="px-6 py-3"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100 text-slate-700">
          <%= render partial: "feed_monitor/sources/row", collection: @sources, as: :source, locals: { item_activity_rates: @item_activity_rates } %>

          <% if @sources.blank? %>
            <tr>
              <td colspan="7" class="px-6 py-6 text-center text-sm text-slate-500">
                No sources yet. <%= link_to "Create the first source", feed_monitor.new_source_path, class: "text-blue-600 hover:text-blue-500" %>.
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
</div>
