<% counts = (local_assigns[:counts] || {}).with_indifferent_access %>
<% selected = (local_assigns[:selected] || :current).to_sym %>
<% scraping_enabled = source.scraping_enabled? %>
<% options = [
     { value: :current, label: "Current view", count: counts[:current] || 0 },
     { value: :unscraped, label: "Unscraped items", count: counts[:unscraped] || 0 },
     { value: :all, label: "All items", count: counts[:all] || 0 }
   ] %>

<div data-testid="bulk-scrape-form">
  <% if scraping_enabled %>
    <%= form_with url: feed_monitor.scrape_all_source_path(source),
          method: :post,
          scope: :bulk_scrape,
          data: {
            controller: "async-submit",
            action: "turbo:submit-start->async-submit#start turbo:submit-end->async-submit#finish"
          },
          class: "space-y-6" do |form| %>
      <fieldset class="space-y-4" role="radiogroup">
        <legend class="text-xs font-semibold uppercase tracking-wider text-slate-500">Scrape scope</legend>
        <div class="space-y-2">
          <% options.each do |option| %>
            <% value = option[:value] %>
            <% is_selected = (selected == value) %>
            <% count_label = number_with_delimiter(option[:count]) %>
            <label
              class="flex items-center justify-between gap-3 rounded-lg border px-4 py-3 text-sm font-medium transition focus-within:ring-2 focus-within:ring-blue-500 focus-within:ring-offset-2
                     <%= is_selected ? "border-blue-500 bg-blue-50 text-blue-700" : "border-slate-200 bg-white text-slate-600" %>"
              data-testid="bulk-scrape-option-<%= value %>"
            >
              <span class="flex items-center gap-3">
                <%= form.radio_button :selection,
                      value,
                      checked: is_selected,
                      class: "h-4 w-4 text-blue-600 focus:ring-blue-500",
                      data: { testid: "bulk-scrape-radio-#{value}" } %>
                <span><%= option[:label] %></span>
              </span>
              <span class="rounded-full bg-slate-100 px-2 py-0.5 text-xs font-semibold text-slate-600"><%= count_label %></span>
            </label>
          <% end %>
        </div>
      </fieldset>

      <div class="flex items-center justify-end gap-3">
        <button
          type="button"
          class="inline-flex items-center rounded-md border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100"
          data-action="modal#close"
        >
          Cancel
        </button>
        <%= form.submit "Scrape Items",
              class: "inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2",
              data: {
                "async-submit-target": "button",
                "async-submit-loading-text-value": "Enqueuing..."
              } %>
      </div>
    <% end %>
  <% else %>
    <div class="rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-500">
      <p class="font-semibold text-slate-700">Scraping is disabled for this source.</p>
      <p class="mt-1">Enable scraping to queue bulk scrapes.</p>
    </div>
  <% end %>
</div>
