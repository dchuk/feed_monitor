#!/usr/bin/env bash
set -euo pipefail

export COVERAGE=true

TARGETED_TESTS=(
  "test/lib/feed_monitor/health/source_health_check_test.rb"
  "test/lib/feed_monitor/health/source_health_monitor_test.rb"
  "test/lib/feed_monitor/health/source_health_reset_test.rb"
  "test/lib/feed_monitor/health/health_module_test.rb"
  "test/lib/feed_monitor/http_test.rb"
  "test/lib/feed_monitor/logs/table_presenter_test.rb"
)

run_tests() {
  if command -v rbenv >/dev/null 2>&1; then
    rbenv exec "$@"
  else
    "$@"
  fi
}

run_tests bundle exec rails test "$@"

run_tests \
  env SIMPLECOV_COMMAND_NAME=feed_monitor:health_suite COVERAGE=true \
  bundle exec rails test "${TARGETED_TESTS[@]}"
