#!/usr/bin/env bash
set -euo pipefail

export COVERAGE=true
export SIMPLECOV_COMMAND_NAME="${SIMPLECOV_COMMAND_NAME:-feedmon:test}"

if [ -d coverage ]; then
  rm -rf coverage
fi

TARGETED_TESTS=(
  "test/lib/feedmon/health/source_health_check_test.rb"
  "test/lib/feedmon/health/source_health_monitor_test.rb"
  "test/lib/feedmon/health/source_health_reset_test.rb"
  "test/lib/feedmon/health/health_module_test.rb"
  "test/lib/feedmon/http_test.rb"
  "test/lib/feedmon/logs/table_presenter_test.rb"
  "test/models/feedmon/log_entry_test.rb"
  "test/controllers/feedmon/source_health_checks_controller_test.rb"
  "test/controllers/feedmon/source_health_resets_controller_test.rb"
  "test/helpers/feedmon/application_helper_test.rb"
  "test/lib/feedmon/fetching/stalled_fetch_reconciler_test.rb"
  "test/lib/feedmon/jobs/fetch_failure_subscriber_test.rb"
  "test/lib/feedmon/scheduler_test.rb"
)

run_tests() {
  if command -v rbenv >/dev/null 2>&1; then
    rbenv exec "$@"
  else
    "$@"
  fi
}

run_tests bundle exec rails test "$@"

run_tests_with_env() {
  if command -v rbenv >/dev/null 2>&1; then
    FEEDMON_TEST_WORKERS=1 SIMPLECOV_COMMAND_NAME=feedmon:health_suite COVERAGE=true rbenv exec bundle exec rails test "$@"
  else
    FEEDMON_TEST_WORKERS=1 SIMPLECOV_COMMAND_NAME=feedmon:health_suite COVERAGE=true bundle exec rails test "$@"
  fi
}

run_tests_with_env "${TARGETED_TESTS[@]}"
